<!doctype html>
<html lang="en" th:lang="${language}" th:class="|theme-${theme}|" xmlns:th="http://www.thymeleaf.org">
  <head
    th:replace="~{_layout::head(title=~{::title}, scripts=~{::scripts}, scriptsDefer=~{::scriptsDefer}, preload=~{::preload})}"
  >
    <title th:text="#{sicknotes.header.title}">Krankmeldungen</title>
    <th:block th:fragment="scripts">
      <script th:inline="javascript">
        /*<![CDATA[*/
        window.uv = window.uv || {};
        window.uv.webPrefix = /*[[@{/web}]]*/ "/web";
        window.uv.apiPrefix = /*[[@{/api}]]*/ "/api";
        /*]]>*/
      </script>
      <script th:replace="~{fragments/datepicker-localization :: datepicker-localization}"></script>
    </th:block>
    <th:block th:fragment="preload">
      <link rel="preload" th:replace="~{fragments/asset-dependency-preload::links('sick_notes.js')}" />
    </th:block>
    <th:block th:fragment="scriptsDefer">
      <script defer type="module" asset:src="sick_notes.js"></script>
    </th:block>
  </head>
  <body th:replace="~{_layout::body(~{::main}, ~{})}">
    <main th:fragment="main" class="max-w-6xl mx-auto px-4 lg:px-12 xl:px-0" data-turbo="true">
      <div
        th:replace="~{fragments/section-heading::section-heading(~{::sick-notes-heading-body}, ~{::sick-notes-heading-actions})}"
      >
        <th:block th:ref="sick-notes-heading-body">
          <h1 th:text="#{sicknotes.title}">Krankmeldungen</h1>
        </th:block>
        <th:block th:ref="sick-notes-heading-actions">
          <div class="flex flex-col sm:flex-row sm:gap-2">
            <a th:href="@{/web/absences}" class="icon-link flex items-center flex-row-reverse sm:flex-row">
              <svg th:replace="~{icon/calendar::svg(className='w-5 h-5')}"></svg>&nbsp;
              <span th:text="#{action.applications.absences_overview}"></span>
            </a>
            <a
              th:href="@{/web/sicknote/statistics}"
              class="icon-link flex items-center flex-row-reverse sm:flex-row"
              th:data-title="#{action.sicknotes.statistics}"
            >
              <svg th:replace="~{icon/presentation-chart-bar::svg(className='w-5 h-5')}"></svg>&nbsp;
              <span th:text="#{action.sicknotes.statistics}"></span>
            </a>
            <div
              th:replace="~{fragments/popover::popover-menu(
                summary=~{::download-dropdown-summary}, content=~{::download-dropdown-content}, placement='bottom-end'
              )}"
            >
              <th:block th:ref="download-dropdown-summary">
                <span class="icon-link text-base flex items-center flex-row-reverse sm:flex-row">
                  <svg th:replace="~{icon/download::svg(className='w-5 h-5')}"></svg>&nbsp;
                  <span id="statistics-download-label" th:text="#{action.sicknotes.download}"></span>
                </span>
              </th:block>
              <th:block th:ref="download-dropdown-content">
                <span class="block mb-2 px-4 font-bold" th:text="#{action.sicknotes.download.title}">
                  Krankmeldungen
                </span>
                <ul class="space-y-2" aria-labelledby="statistics-download-label">
                  <li>
                    <a
                      id="statistics-csv-download-link-all"
                      th:href="@{/web/sickdays/statistics/download (from=${from}, to=${to}, sort=${sortQuery}, query=${query}, allElements=${true})}"
                      class="icon-link"
                      download
                    >
                      <svg th:replace="~{icon/download::svg(className='w-5 h-5')}"></svg>&nbsp;
                      <th:block th:text="#{action.sicknotes.download.all.persons}"></th:block>
                    </a>
                  </li>
                  <li>
                    <a
                      id="statistics-csv-download-link"
                      th:href="@{/web/sickdays/statistics/download (from=${from}, to=${to}, page=${statisticsPagination.page.number + 1}, size=${statisticsPagination.page.size}, sort=${sortQuery}, query=${query})}"
                      class="icon-link"
                      download
                    >
                      <svg th:replace="~{icon/download::svg(className='w-5 h-5')}"></svg>&nbsp;
                      <th:block th:text="#{action.sicknotes.download.visible.persons}"></th:block>
                    </a>
                  </li>
                </ul>
              </th:block>
            </div>
            <button th:replace="~{fragments/print::button}"></button>
          </div>
        </th:block>
      </div>

      <div class="flex flex-col md:flex-row gap-4">
        <div class="flex flex-col md:grid md:grid-rows-2 lg:flex lg:flex-row gap-4 md:gap-2 print:hidden">
          <div
            th:replace="~{fragments/popover::popover-select(
              summary=~{::period-dropdown-summary}, content=~{::period-dropdown-content}, placement='bottom-start'
            )}"
          >
            <th:block th:ref="period-dropdown-summary">
              <th:block th:text="#{sicknotes.statistics.period.legend.text}"></th:block>
              <span
                id="period-text"
                th:with="start=${{period.startDate}}, end=${{period.endDate}}"
                th:text="#{sicknotes.statistics.period.selected(${start}, ${end})}"
              ></span>
            </th:block>
            <th:block th:ref="period-dropdown-content">
              <form
                method="get"
                action="#"
                th:action="@{/web/sickdays}"
                data-turbo-frame="frame-statistics"
                data-turbo-action="advance"
                id="form-date-from-to"
              >
                <div id="statistics-filter-inputs">
                  <input type="hidden" name="sort" th:value="${sortQuery}" />
                  <input type="hidden" name="query" th:value="${query}" />
                </div>
                <div class="flex flex-col gap-1">
                  <fieldset>
                    <legend class="sr-only" th:text="#{sicknotes.statistics.period.legend.text}">Zeitraum</legend>
                    <div class="flex flex-col">
                      <label th:text="|#{filter.period.startDate}: |" for="from-date-input">Von</label>
                      <input
                        id="from-date-input"
                        name="from"
                        th:value="${{period.startDate}}"
                        th:data-iso-value="${period.startDateIsoValue}"
                        th:placeholder="#{pattern.date}"
                        class="mt-0.5"
                      />
                      <label th:text="|#{filter.period.endDate}: |" for="to-date-input" class="mt-4"> Bis </label>
                      <input
                        id="to-date-input"
                        name="to"
                        th:value="${{period.endDate}}"
                        th:data-iso-value="${period.endDateIsoValue}"
                        th:placeholder="#{pattern.date}"
                        class="mt-0.5"
                      />
                    </div>
                    <div class="mt-6">
                      <button th:text="#{action.confirm}" class="button-main py-1.5 px-3 w-full" type="submit" />
                    </div>
                  </fieldset>
                </div>
              </form>
            </th:block>
          </div>
          <form
            action="#"
            th:action="@{/web/sickdays}"
            method="get"
            class="flex"
            data-turbo-frame="frame-statistics"
            data-turbo-action="advance"
          >
            <div id="statistics-form-query-inputs">
              <input type="hidden" name="from" th:value="${period.startDateIsoValue}" />
              <input type="hidden" name="to" th:value="${period.endDateIsoValue}" />
              <input type="hidden" name="size" th:value="${statisticsPagination.page.size}" />
              <input type="hidden" name="sort" th:value="${sortQuery}" />
            </div>
            <div class="flex-1 flex flex-col md:flex-row">
              <label for="search" class="md:sr-only"> <th:block th:text="#{action.search}">Suchen</th:block>: </label>
              <span
                th:replace="~{fragments/input-group::input-group(~{::search-input}, ~{::search-input-addon}, ${false})}"
              >
                <th:block th:ref="search-input">
                  <label for="search" th:text="#{action.search}" class="sr-only"></label>
                  <input
                    type="text"
                    id="search"
                    name="query"
                    th:value="${query}"
                    class="pr-8 border-none w-full md:w-auto"
                    th:placeholder="#{action.search.placeholder.firstname-lastname}"
                    data-auto-submit="search-submit"
                    data-auto-submit-delay="100"
                  />
                </th:block>
                <th:block th:ref="search-input-addon">
                  <button type="submit" id="search-submit" class="flex items-center dark:bg-zinc-800">
                    <svg th:replace="~{icon/search::svg(className='w-5 h-5 stroke-2')}"></svg>
                    <span class="sr-only" th:text="#{action.search}">Suche</span>
                  </button>
                </th:block>
              </span>
            </div>
          </form>
        </div>
        <div class="md:ml-auto">
          <form
            action="#"
            th:action="@{/web/sickdays}"
            method="get"
            data-turbo-frame="frame-statistics"
            data-turbo-action="advance"
          >
            <div id="statistics-form-sort-inputs">
              <input type="hidden" name="from" th:value="${period.startDateIsoValue}" />
              <input type="hidden" name="to" th:value="${period.endDateIsoValue}" />
              <input type="hidden" name="size" th:value="${statisticsPagination.page.size}" />
              <input type="hidden" name="query" th:value="${query}" />
            </div>
            <div class="flex flex-col md:flex-row md:items-center md:gap-2">
              <label for="sort-select"> <th:block th:text="#{action.sort}">Sortieren</th:block>: </label>
              <select
                id="sort-select"
                name="sort"
                th:replace="~{fragments/select::one(id='sort-select', name='sort', options=~{::sort-select-options}, autosubmit='sort-submit')}"
              >
                <th:block th:ref="sort-select-options">
                  <optgroup
                    th:each="optgroup : ${sortSelect.optgroups}"
                    th:label="${#messages.msg(optgroup.labelMessageKey)}"
                  >
                    <option
                      th:each="option : ${optgroup.options}"
                      th:value="${option.value}"
                      th:text="${#messages.msg(option.textMessageKey)}"
                      th:selected="${option.selected}"
                    ></option>
                  </optgroup>
                </th:block>
              </select>
              <button type="submit" id="sort-submit" class="button-main" th:text="#{action.sort}" data-js-hidden>
                Sortieren
              </button>
            </div>
          </form>
        </div>
      </div>

      <turbo-frame id="frame-statistics">
        <th:block th:if="${turboFrameRequested}">
          <turbo-stream target="statistics-csv-download-link-all" action="replace">
            <template th:insert="~{::#statistics-csv-download-link-all}"></template>
          </turbo-stream>
          <turbo-stream target="statistics-csv-download-link" action="replace">
            <template th:insert="~{::#statistics-csv-download-link}"></template>
          </turbo-stream>
          <turbo-stream target="statistics-filter-inputs" action="replace">
            <template th:insert="~{::#statistics-filter-inputs}"></template>
          </turbo-stream>
          <turbo-stream target="statistics-form-query-inputs" action="replace">
            <template th:insert="~{::#statistics-form-query-inputs}"></template>
          </turbo-stream>
          <turbo-stream target="period-text" action="replace">
            <template th:insert="~{::#period-text}"></template>
          </turbo-stream>
          <turbo-stream target="statistics-form-sort-inputs" action="replace">
            <template th:insert="~{::#statistics-form-sort-inputs}"></template>
          </turbo-stream>
          <turbo-stream target="pagination" action="replace">
            <template th:insert="~{::#pagination}"></template>
          </turbo-stream>
          <turbo-stream target="pagination-form-size-inputs" action="replace">
            <template th:insert="~{::#pagination-form-size-inputs}"></template>
          </turbo-stream>
          <turbo-stream target="pagination-size-hint" action="replace">
            <template th:insert="~{::#pagination-size-hint}"></template>
          </turbo-stream>
        </th:block>

        <div
          th:if="${errorEndDateBeforeStartDate}"
          th:text="#{__${errorEndDateBeforeStartDate}__}"
          class="mt-8 alert alert-danger"
        ></div>

        <table
          th:unless="${errorEndDateBeforeStartDate}"
          id="sick-note-table"
          class="mt-8 md:mt-16 list-table hoverable-table text-sm"
          data-test-id="sick-notes-table"
        >
          <caption class="sr-only" th:text="#{sicknotes.title}">
            Krankmeldungen
          </caption>
          <thead class="hidden lg:table-header-group">
            <tr>
              <th scope="col" class="print:hidden"></th>
              <th
                scope="col"
                th:if="${showPersonnelNumberColumn}"
                th:text="#{person.account.basedata.personnelNumber.abbreviation}"
                class="hidden lg:table-cell print:table-cell"
              ></th>
              <th scope="col" th:text="#{person.data.firstName}"></th>
              <th scope="col" th:text="#{person.data.lastName}"></th>
              <th scope="col" class="hidden">
                <!-- placeholder for first name and last name column in xs screen-->
              </th>
              <th scope="col" th:text="#{sicknotes.daysOverview.sickDays.title}"></th>
              <th scope="col" th:text="#{sicknotes.daysOverview.sickDays.child.title}"></th>
              <th scope="col" class="hidden"><!-- placeholder for sick days column in xs screen--></th>
            </tr>
          </thead>
          <tbody>
            <tr th:each="sickDaysStatistic : ${statisticsPagination.page.content}">
              <td class="is-centered print:hidden text-blue-50 dark:text-sky-800">
                <img
                  th:replace="~{fragments/avatar::avatar-bordered(url=${sickDaysStatistic.personAvatarUrl + '?d=404&s=40'},niceName=${sickDaysStatistic.personNiceName},initials=${sickDaysStatistic.personInitials},width='40',height='40',personId=${sickDaysStatistic.personId})}"
                  alt=""
                />
              </td>
              <td
                th:if="${showPersonnelNumberColumn}"
                th:text="${sickDaysStatistic.personnelNumber}"
                class="hidden lg:table-cell print:table-cell text-ellipsis overflow-hidden max-w-xs text-center"
              ></td>
              <td class="hidden md:table-cell">
                <a
                  th:text="${sickDaysStatistic.personFirstName}"
                  th:href="@{/web/person/__${sickDaysStatistic.personId}__/overview}"
                  class="icon-link"
                  data-turbo="false"
                ></a>
              </td>
              <td class="hidden md:table-cell">
                <a
                  th:text="${sickDaysStatistic.personLastName}"
                  th:href="@{/web/person/__${sickDaysStatistic.personId}__/overview}"
                  class="icon-link"
                  data-turbo="false"
                ></a>
              </td>
              <td class="md:hidden">
                <a
                  th:text="${sickDaysStatistic.personNiceName}"
                  th:href="@{/web/person/__${sickDaysStatistic.personId}__/overview}"
                  class="icon-link"
                  data-turbo="false"
                ></a>
              </td>
              <td class="hidden md:table-cell">
                <a
                  th:href="@{/web/person/__${sickDaysStatistic.personId}__/overview#anchorSickNotes}"
                  class="icon-link"
                  data-turbo="false"
                >
                  <div class="flex items-center">
                    <svg th:replace="~{icon/medkit::svg(className='w-4 h-4')}"></svg>
                    &nbsp;<th:block
                      th:replace="~{fragments/number::number(${sickDaysStatistic.amountSickDays})}"
                    ></th:block>
                    <th:block th:text="#{sicknotes.daysOverview.sickDays.number}"></th:block>
                  </div>
                </a>
                <p
                  th:if="${sickDaysStatistic.amountSickDaysWithAUB > 0}"
                  class="list-table--second-row flex items-center"
                >
                  <span class="text-emerald-500 flex items-center">
                    <svg th:replace="~{icon/check::svg(className='w-4 h-4')}"></svg>
                  </span>
                  <th:block
                    th:text="| #{overview.sicknotes.sickdays.aub(${sickDaysStatistic.amountSickDaysWithAUB})}|"
                  ></th:block>
                </p>
              </td>
              <td class="hidden md:table-cell">
                <a
                  th:href="@{/web/person/__${sickDaysStatistic.personId}__/overview#anchorSickNotes}"
                  class="icon-link"
                  data-turbo="false"
                >
                  <div class="flex items-center">
                    <svg th:replace="~{icon/child::svg(className='w-3 h-3')}"></svg>
                    &nbsp;<th:block
                      th:replace="~{fragments/number::number(${sickDaysStatistic.amountChildSickDays})}"
                    ></th:block>
                    <th:block th:text="#{sicknotes.daysOverview.sickDays.child.number}"></th:block>
                  </div>
                </a>
                <p
                  th:if="${sickDaysStatistic.amountChildSickDaysWithAUB > 0}"
                  class="list-table--second-row flex items-center"
                >
                  <span class="text-emerald-500 flex items-center">
                    <svg th:replace="~{icon/check::svg(className='w-4 h-4')}"></svg>
                  </span>
                  <th:block
                    th:text="#{overview.sicknotes.sickdays.aub(${sickDaysStatistic.amountChildSickDaysWithAUB})}"
                  ></th:block>
                </p>
              </td>
              <td class="md:hidden">
                <div class="flex items-center">
                  <svg th:replace="~{icon/medkit::svg(className='w-3 h-3')}"></svg>
                  &nbsp;<th:block
                    th:replace="~{fragments/number::number(${sickDaysStatistic.amountSickDays})}"
                  ></th:block>
                  <th:block th:if="${sickDaysStatistic.amountSickDaysWithAUB > 0}">
                    &nbsp; (&nbsp;<svg th:replace="~{icon/check::svg(className='w-4 h-4 text-emerald-500')}"></svg>
                    <th:block
                      th:replace="~{fragments/number::number(${sickDaysStatistic.amountSickDaysWithAUB})}"
                    ></th:block>
                    )
                  </th:block>
                </div>
                <div class="flex items-center">
                  <svg th:replace="~{icon/child::svg(className='w-3 h-3')}"></svg>
                  &nbsp;<th:block
                    th:replace="~{fragments/number::number(${sickDaysStatistic.amountChildSickDays})}"
                  ></th:block>
                  <th:block th:if="${sickDaysStatistic.amountChildSickDaysWithAUB > 0}">
                    &nbsp; (&nbsp;<svg th:replace="~{icon/check::svg(className='w-4 h-4 text-emerald-500')}"></svg>
                    <th:block
                      th:replace="~{fragments/number::number(${sickDaysStatistic.amountChildSickDaysWithAUB})}"
                    ></th:block>
                    )
                  </th:block>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </turbo-frame>

      <div class="mt-8 md:mt-16 flex flex-col md:flex-row md:items-center gap-8">
        <div id="pagination">
          <nav
            th:replace="~{fragments/pagination::pagination(${statisticsPagination}, #{applications.statistics.pagination.navigation.aria-label}, 'frame-statistics')}"
          ></nav>
        </div>
        <form
          action="#"
          th:action="@{/web/sickdays}"
          method="get"
          class="md:ml-auto flex items-center"
          data-turbo-frame="frame-statistics"
          data-turbo-action="advance"
        >
          <div id="pagination-form-size-inputs">
            <input type="hidden" name="from" th:value="${period.startDateIsoValue}" />
            <input type="hidden" name="to" th:value="${period.endDateIsoValue}" />
            <input type="hidden" name="sort" th:value="${sortQuery}" />
            <input type="hidden" name="query" th:value="${query}" />
          </div>
          <div class="flex items-center gap-2">
            <label for="pagination-size-select" th:text="#{pagination.page.size.label.text}"> Zeige </label>
            <span>
              <select
                name="size"
                id="pagination-size-select"
                th:replace="~{fragments/pagination::default-size-select(id='pagination-size-select', size=${statisticsPagination.page.size}, autosubmit='size-submit')}"
              ></select>
            </span>
            <span
              id="pagination-size-hint"
              class="whitespace-nowrap"
              th:text="#{pagination.page.size.total.text(${statisticsPagination.page.totalElements}, ${#messages.msg('applications.statistics.pagination.total.text')})}"
            >
              von 42 Personen
            </span>
          </div>
          <button
            id="size-submit"
            th:text="#{pagination.page.size.button.text}"
            class="ml-2 button-main"
            data-js-hidden
          >
            Aktualisieren
          </button>
        </form>
      </div>
    </main>
  </body>
</html>
